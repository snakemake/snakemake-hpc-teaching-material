on:
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: write
  repository-projects: read
  actions: read

name: release-please

jobs:
  release-please:
    runs-on: ubuntu-latest
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
    steps:
      - uses: GoogleCloudPlatform/release-please-action@v4
        id: release
        with:
          release-type: simple

  publish:
    needs: release-please
    if: needs.release-please.outputs.release_created == 'true'
    name: Publish Release Artifacts
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: write
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Try download Slides artifact from latest successful build
        id: download-slides
        uses: dawidd6/action-download-artifact@v6
        with:
          workflow: build.yml
          workflow_conclusion: success
          commit: ${{ github.sha }}
          name: Slides
          path: slides
          check_artifacts: true
          if_no_artifact_found: ignore

      - name: Check for PDFs and trigger rebuild if missing
        id: ensure-slides
        run: |
          set -euo pipefail
          echo "Installing helper packages"
          sudo apt-get update && sudo apt-get install -y jq unzip
          echo "Listing slides directory"
          ls -la slides || true
          count=$(ls slides/*.pdf 2>/dev/null | wc -l || true)
          echo "pdf_count=$count" >> $GITHUB_OUTPUT
          if [ "$count" -eq 0 ]; then
            echo "No slides PDFs found. Triggering build workflow..."
            # Trigger workflow_dispatch for build.yml
            resp=$(curl -s -X POST \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              https://api.github.com/repos/${{ github.repository }}/actions/workflows/build.yml/dispatches \
              -d '{"ref":"main"}')
            echo "trigger_response=$resp" >> $GITHUB_OUTPUT
            # Wait for the workflow run to start and finish
            echo "Waiting for build workflow to complete..."
            owner_repo="${{ github.repository }}"
            # poll for latest workflow run for build.yml
            attempt=0
            while [ $attempt -lt 60 ]; do
              attempt=$((attempt+1))
              run_id=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
                -H "Accept: application/vnd.github+json" \
                "https://api.github.com/repos/$owner_repo/actions/workflows/build.yml/runs?per_page=1" \
                | jq -r '.workflow_runs[0].id // empty')
              status=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
                -H "Accept: application/vnd.github+json" \
                "https://api.github.com/repos/$owner_repo/actions/runs/$run_id" \
                | jq -r '.status // empty')
              conclusion=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
                -H "Accept: application/vnd.github+json" \
                "https://api.github.com/repos/$owner_repo/actions/runs/$run_id" \
                | jq -r '.conclusion // empty')
              echo "Attempt $attempt: run_id=$run_id status=$status conclusion=$conclusion"
              if [ -n "$status" ] && [ "$status" = "completed" ]; then
                echo "Build run completed with conclusion=$conclusion"
                echo "build_run_id=$run_id" >> $GITHUB_OUTPUT
                if [ "$conclusion" != "success" ]; then
                  echo "Build failed (conclusion=$conclusion). Exiting with error."
                  exit 1
                fi
                break
              fi
              sleep 10
            done
            if [ $attempt -ge 60 ]; then
              echo "Timed out waiting for build workflow to complete." >&2
              exit 1
            fi
            # Re-download artifacts from the successful build run
            echo "Re-downloading Slides artifact from latest successful build"
            uses_cmd='uses=dawidd6/action-download-artifact@v6'
            # We cannot call an action from shell; instead use the GitHub API to download artifact
            # Find the artifact id
            artifact_id=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/repos/$owner_repo/actions/runs/$run_id/artifacts" \
              | jq -r '.artifacts[] | select(.name=="Slides") | .id // empty')
            if [ -z "$artifact_id" ]; then
              echo "Slides artifact not found in run $run_id" >&2
              exit 1
            fi
            download_url=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/repos/$owner_repo/actions/artifacts/$artifact_id/zip" \
              | jq -r '.archive_download_url // empty')
            # The API returns a redirect; use curl to download and unzip
            tmpzip=slides_artifact.zip
            curl -L -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" -o $tmpzip "https://api.github.com/repos/$owner_repo/actions/artifacts/$artifact_id/zip"
            mkdir -p slides
            unzip -o $tmpzip -d slides
            rm -f $tmpzip
          else
            echo "Slides PDF(s) already present (count=$count), skipping rebuild."
          fi

      - name: Zip solutions and tutorial folders
        run: |
          cd setup_creators
          zip -r ../setup_creators_material.zip solutions tutorial
          cd ..

      - name: Attach PDFs to Release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ needs.release-please.outputs.tag_name }}
          fail_on_unmatched_files: false
          files: |
            slides/*.pdf
            setup_creators_material.zip
