on:
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: write
  repository-projects: read
  actions: read

name: release-please

jobs:
  release-please:
    runs-on: ubuntu-latest
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
    steps:
      - uses: GoogleCloudPlatform/release-please-action@v4
        id: release
        with:
          release-type: simple

  publish:
    needs: release-please
    if: needs.release-please.outputs.release_created == 'true'
    name: Check & Publish Release Artifacts
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: write
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Try download Slides artifact from latest successful build
        id: download-slides
        uses: dawidd6/action-download-artifact@v6
        with:
          workflow: build.yml
          workflow_conclusion: success
          commit: ${{ github.sha }}
          name: Slides
          path: slides
          check_artifacts: true
          if_no_artifact_found: ignore

      - name: Check for PDFs
        id: check-pdfs
        run: |
          set -euo pipefail
          ls -la slides || true
          count=$(ls slides/*.pdf 2>/dev/null | wc -l || true)
          echo "pdf_count=$count" >> $GITHUB_OUTPUT

      - name: Build slides if needed (dispatch build.yml and fetch artifacts)
        if: steps.check-pdfs.outputs.pdf_count == '0'
        env:
          REPO: ${{ github.repository }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RELEASE_TAG: ${{ needs.release-please.outputs.tag_name }}
        run: |
          set -euo pipefail
          sudo apt-get update && sudo apt-get install -y jq unzip
          ref_to_use="${RELEASE_TAG:-main}"
          if [ -z "$ref_to_use" ] || [ "$ref_to_use" = "null" ]; then
            ref_to_use=main
          fi
          echo "Dispatching build.yml on ref: $ref_to_use"
          start_time=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          dispatch_resp=$(curl -s -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            "https://api.github.com/repos/$REPO/actions/workflows/build.yml/dispatches" \
              -d '{"ref":"'"$ref_to_use"'"}')
            echo "dispatch response: $dispatch_resp"

            # Poll for a workflow run that started after we dispatched
            echo "Waiting for a build run to start..."
            run_id=''
            attempts=0
            while [ $attempts -lt 60 ]; do
              attempts=$((attempts+1))
              candidate=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" -H "Accept: application/vnd.github+json" "https://api.github.com/repos/$REPO/actions/workflows/build.yml/runs?event=workflow_dispatch&per_page=5" )
              # find the first run with created_at >= start_time
              run_id=$(echo "$candidate" | jq -r --arg START "$start_time" '.workflow_runs[] | select(.created_at >= $START) | .id' | head -n1 || true)
              if [ -n "$run_id" ]; then
                echo "Found run id: $run_id"
                break
              fi
              sleep 2
            done
            if [ -z "$run_id" ]; then
              echo "Timed out waiting for a new build run to start" >&2
              exit 1
            fi

            # Wait for run to complete
            echo "Waiting for run $run_id to complete..."
            attempts=0
            while [ $attempts -lt 180 ]; do
              attempts=$((attempts+1))
              status=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" -H "Accept: application/vnd.github+json" "https://api.github.com/repos/$REPO/actions/runs/$run_id" | jq -r '.status')
              conclusion=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" -H "Accept: application/vnd.github+json" "https://api.github.com/repos/$REPO/actions/runs/$run_id" | jq -r '.conclusion')
              echo "Attempt $attempts: status=$status conclusion=$conclusion"
              if [ "$status" = "completed" ]; then
                if [ "$conclusion" != "success" ]; then
                  echo "Build run failed with conclusion=$conclusion" >&2
                  exit 1
                fi
                echo "Run $run_id completed successfully"
                break
              fi
              sleep 10
            done
            if [ $attempts -ge 180 ]; then
              echo "Timed out waiting for run to complete" >&2
              exit 1
            fi

            # Download artifact 'Slides' from the run
            echo "Fetching artifacts for run $run_id"
            artifacts=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" -H "Accept: application/vnd.github+json" "https://api.github.com/repos/$REPO/actions/runs/$run_id/artifacts")
            artifact_id=$(echo "$artifacts" | jq -r '.artifacts[] | select(.name=="Slides") | .id' || true)
            if [ -z "$artifact_id" ]; then
              echo "Slides artifact not found in run $run_id" >&2
              exit 1
            fi
            echo "Downloading artifact id $artifact_id"
            tmpzip=slides_artifact.zip
            curl -L -H "Authorization: Bearer $GITHUB_TOKEN" -o $tmpzip "https://api.github.com/repos/$REPO/actions/artifacts/$artifact_id/zip"
            mkdir -p slides
            unzip -o $tmpzip -d slides
            rm -f $tmpzip

      - name: Zip solutions and tutorial folders
        run: |
          cd setup_creators
          zip -r ../setup_creators_material.zip solutions tutorial
          cd ..

      - name: Attach PDFs to Release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ needs.release-please.outputs.tag_name }}
          fail_on_unmatched_files: false
          files: |
            slides/*.pdf
            setup_creators_material.zip
